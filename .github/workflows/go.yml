name: Unit-Tests
on:
  pull_request:
    paths:
      - 'go.mod'
      - '**.go'
      - '**.yml'
  push:
    paths:
      - 'go.mod'
      - '**.go'
      - '**.yml'

jobs:

  test:
    name: Test on go ${{ matrix.go_version }} and ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go_version: ['1.20']

    steps:
    - name: Check out code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        path: main

    - name: Checkout deps repo
      working-directory: ${{ github.workspace }}
      run: |
        git clone --depth=0  https://github.com/gookit/goutil

    - name: Checkout deps repo - goutil
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        repository: gookit/goutil
        path: goutil

    - name: Checkout deps repo - greq
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        repository: gookit/greq
        path: greq

    - name: Checkout deps repo - greq
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        repository: gookit/greq
        path: greq

    - name: Checkout deps repo - gcli
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        repository: gookit/gcli
        path: gcli

    - name: Setup Go Faster
      uses: WillAbides/setup-go-faster@v1.8.0
      timeout-minutes: 3
      with:
        go-version: ${{ matrix.go_version }}

    # pwd == ${{ github.workspace }}
    # mkdir -p ${{ github.workspace }}/go/src/github.com/${{ github.repository }}
    - name: Prepare go workspace
      run: |
        pwd
        ls -al ../
        cp .github/go.work.example ../go.work
        git clone https://github.com/gookit/goutil ${{ github.workspace }}/../goutil
        echo "${{ github.workspace }}/go/bin" >> $GITHUB_PATH

    - name: Run unit tests
      # run: go test -v -cover ./...
      # must add " for profile.cov on Windows OS
      # go test -v -coverprofile="profile.cov" ./...
      run: |
        pwd
        go mod tidy
        make install
        kite -V
        kite

